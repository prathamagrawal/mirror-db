# =============================================================================
# PostgreSQL HA Cluster - Production Values (Minikube Optimized)
# =============================================================================

# -- Global settings
global:
  namespace: "db-production"
  labels:
    app.kubernetes.io/name: postgres-cluster
    app.kubernetes.io/managed-by: helm
    environment: production

# -- Namespace configuration
namespace:
  create: true
  name: "db-production"

# =============================================================================
# PostgreSQL Configuration
# =============================================================================
postgresql:
  version: "15"
  port: 5432
  monitorPort: 6001

  image:
    repository: citusdata/pg_auto_failover
    tag: latest
    pullPolicy: IfNotPresent

  cluster:
    # Reduced to 2 nodes for Minikube (1 primary + 1 replica)
    replicaCount: 2

  tuning:
    maxConnections: 100
    sharedBuffers: "64MB"
    effectiveCacheSize: "256MB"
    walBuffers: "8MB"
    maxWalSenders: 5
    maxReplicationSlots: 5
    walKeepSegments: 32

  # -- Minimal resources for local testing
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  probes:
    readiness:
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    liveness:
      initialDelaySeconds: 30
      periodSeconds: 45
      timeoutSeconds: 15
      failureThreshold: 4

  storage:
    size: "5Gi"  # Reduced for Minikube
    storageClass: ""  # Use default storage class

  # -- Disabled for single-node Minikube
  affinity:
    enabled: false
    hostnameWeight: 100
    zoneWeight: 50

  topologySpread:
    enabled: false  # Not useful with single node

# =============================================================================
# Monitor Configuration
# =============================================================================
monitor:
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  storage:
    size: "2Gi"  # Reduced for Minikube
    storageClass: ""

  probes:
    readiness:
      initialDelaySeconds: 30
      periodSeconds: 15
      timeoutSeconds: 10
      failureThreshold: 5
    liveness:
      initialDelaySeconds: 30
      periodSeconds: 15
      timeoutSeconds: 10
      failureThreshold: 5

# =============================================================================
# PgBouncer Configuration
# =============================================================================
pgbouncer:
  enabled: true

  image:
    repository: edoburu/pgbouncer
    tag: latest
    pullPolicy: IfNotPresent

  port: 6432
  replicas: 1  # Single replica for Minikube

  pooling:
    mode: "transaction"
    defaultPoolSize: 5  # Reduced for testing
    maxClientConn: 50
    reservePoolSize: 1
    maxDbConnections: 25

  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "250m"

  busybox:
    image: busybox
    tag: "1.36"

# =============================================================================
# Pod Labeler Configuration
# =============================================================================
podLabeler:
  enabled: true

  image:
    repository: python
    tag: "3.11-slim-bookworm"
    pullPolicy: IfNotPresent

  resources:
    requests:
      memory: "32Mi"
      cpu: "10m"
    limits:
      memory: "64Mi"
      cpu: "50m"

# =============================================================================
# Security Configuration
# =============================================================================
security:
  podSecurityContext:
    fsGroup: 101
    runAsUser: 101
    runAsGroup: 101

  containerSecurityContext:
    runAsUser: 101
    runAsGroup: 101
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false

# =============================================================================
# Credentials Configuration
# =============================================================================
credentials:
  postgres:
    user: "postgres"
    password: "prod_postgres_secure_2024"

  replicator:
    user: "pgautofailover_replicator"
    password: "prod_replicator_secure_2024"

  monitor:
    user: "autoctl_node"
    password: "prod_monitor_secure_2024"

  app:
    user: "appuser"
    password: "prod_app_secure_2024"

  existingSecret: ""

# =============================================================================
# High Availability Configuration
# =============================================================================
ha:
  podDisruptionBudget:
    enabled: true
    postgresNodes:
      minAvailable: 1  # At least 1 of 2 nodes
    monitor:
      minAvailable: 1
    pgbouncer:
      minAvailable: 1

# =============================================================================
# Service Configuration
# =============================================================================
services:
  monitor:
    type: ClusterIP
  primary:
    type: ClusterIP
  replicas:
    type: ClusterIP
  pgbouncer:
    type: ClusterIP

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  name: ""
  annotations: {}

# =============================================================================
# RBAC Configuration
# =============================================================================
rbac:
  create: true

# =============================================================================
# Node Selection & Scheduling
# =============================================================================
nodeSelector: {}

tolerations: []

# =============================================================================
# Network Policies
# =============================================================================
networkPolicy:
  enabled: false
  ingressRules: []
  egressRules: []

# =============================================================================
# Metrics & Monitoring
# =============================================================================
metrics:
  enabled: false
  
  serviceMonitor:
    enabled: false
    namespace: ""
    interval: "30s"
    labels: {}

# =============================================================================
# TLS Configuration
# =============================================================================
tls:
  enabled: false
  certManager:
    enabled: false
    issuerRef:
      name: ""
      kind: "ClusterIssuer"
  existingSecret: ""