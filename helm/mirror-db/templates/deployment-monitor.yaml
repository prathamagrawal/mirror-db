apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-monitor
  namespace: {{ include "mirror-db.namespace" . }}
  labels:
    {{- include "mirror-db.labels" . | nindent 4 }}
    app: postgres-monitor
    app.kubernetes.io/component: monitor
spec:
  replicas: 1
  strategy:
    type: Recreate  # Single instance, use Recreate to avoid conflicts
  selector:
    matchLabels:
      app: postgres-monitor
  template:
    metadata:
      labels:
        {{- include "mirror-db.labels" . | nindent 8 }}
        app: postgres-monitor
        app.kubernetes.io/component: monitor
    spec:
      securityContext:
        {{- toYaml .Values.security.podSecurityContext | nindent 8 }}
      terminationGracePeriodSeconds: 30
      initContainers:
        - name: fix-permissions
          image: {{ include "mirror-db.busyboxImage" . }}
          command: ['sh', '-c', 'chown -R 101:101 /var/lib/postgresql && chmod 700 /var/lib/postgresql']
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql
        - name: init-db
          image: {{ include "mirror-db.postgresqlImage" . }}
          imagePullPolicy: {{ .Values.postgresql.image.pullPolicy }}
          command: ["/bin/bash", "-c"]
          args:
            - |
              #!/bin/bash
              set -eux
              export PATH="/usr/lib/postgresql/11/bin:/usr/local/bin:$PATH"
              export PGDATA=/var/lib/postgresql/pgdata/monitor
              export PGPORT={{ .Values.postgresql.monitorPort }}
              export PGUSER=postgres
              mkdir -p $PGDATA
              MY_IP=$(hostname -i)
              pg_autoctl create monitor \
                --hostname "$MY_IP" \
                --pgport "$PGPORT" \
                --auth trust \
                --ssl-self-signed \
                --pgdata "$PGDATA"
              cat >> "$PGDATA/pg_hba.conf" <<EOF
              # Allow PgBouncer non-SSL connections from pod network
              host    all             postgres        10.244.0.0/16           trust
              host    all             postgres        10.96.0.0/12            trust
              # Allow pg_auto_failover connections
              hostssl all all 10.244.0.0/16 trust
              hostssl all all 10.96.0.0/12 trust
              hostssl all all 0.0.0.0/8 trust
              # Allow application connections
              hostssl all postgres 0.0.0.0/0 trust
              EOF
              echo "Initialization complete"
          securityContext:
            {{- toYaml .Values.security.containerSecurityContext | nindent 12 }}
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql
      containers:
        - name: postgres-monitor
          image: {{ include "mirror-db.postgresqlImage" . }}
          imagePullPolicy: {{ .Values.postgresql.image.pullPolicy }}
          command: ["/bin/bash", "-c"]
          args:
            - |
              #!/bin/bash
              pg_autoctl run
          securityContext:
            {{- toYaml .Values.security.containerSecurityContext | nindent 12 }}
          ports:
            - containerPort: {{ .Values.postgresql.monitorPort }}
              name: postgres
          env:
            - name: PGDATA
              value: /var/lib/postgresql/pgdata/monitor
            - name: PGPORT
              value: "{{ .Values.postgresql.monitorPort }}"
            - name: PGUSER
              value: postgres
            - name: PATH
              value: "/usr/lib/postgresql/11/bin:/usr/local/bin:/usr/bin:/bin"
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql/
          readinessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  export PATH="/usr/lib/postgresql/11/bin:/usr/local/bin:$PATH"
                  # Check if postgres is accepting connections
                  pg_isready -h localhost -p {{ .Values.postgresql.monitorPort }} -U postgres -t 5
            initialDelaySeconds: {{ .Values.monitor.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.monitor.probes.readiness.periodSeconds }}
            timeoutSeconds: {{ .Values.monitor.probes.readiness.timeoutSeconds }}
            successThreshold: 1
            failureThreshold: {{ .Values.monitor.probes.readiness.failureThreshold }}
          resources:
            {{- toYaml .Values.monitor.resources | nindent 12 }}
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  export PATH="/usr/lib/postgresql/11/bin:/usr/local/bin:$PATH"
                  pg_isready -h localhost -p {{ .Values.postgresql.monitorPort }} -U postgres
            initialDelaySeconds: {{ .Values.monitor.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.monitor.probes.liveness.periodSeconds }}
            timeoutSeconds: {{ .Values.monitor.probes.liveness.timeoutSeconds }}
            successThreshold: 1
            failureThreshold: {{ .Values.monitor.probes.liveness.failureThreshold }}
      volumes:
        - name: pgdata
          persistentVolumeClaim:
            claimName: {{ include "mirror-db.fullname" . }}-monitor-pvc

