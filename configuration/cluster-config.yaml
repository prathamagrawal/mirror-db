apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-config
  namespace: db
  labels:
    app.kubernetes.io/name: postgres-cluster
    app.kubernetes.io/component: configuration
data:
  # =============================================================================
  # CLUSTER CONFIGURATION
  # Centralized configuration for the PostgreSQL HA cluster
  # Modify these values to customize your deployment
  # =============================================================================

  # Namespace configuration
  NAMESPACE: "db"
  
  # PostgreSQL Configuration
  PG_VERSION: "15"
  PG_PORT: "5432"
  MONITOR_PORT: "6001"
  PGBOUNCER_PORT: "6432"
  
  # Cluster sizing
  REPLICA_COUNT: "4"  # Total nodes: 1 primary + 1 sync + 2 async
  PGBOUNCER_REPLICAS: "1"
  
  # Storage configuration
  STORAGE_CLASS: "standard"
  DATA_STORAGE_SIZE: "50Gi"
  MONITOR_STORAGE_SIZE: "10Gi"
  
  # Resource configuration - Postgres Nodes
  PG_REQUESTS_MEMORY: "512Mi"
  PG_REQUESTS_CPU: "250m"
  PG_LIMITS_MEMORY: "1Gi"
  PG_LIMITS_CPU: "1000m"
  
  # Resource configuration - Monitor
  MONITOR_REQUESTS_MEMORY: "512Mi"
  MONITOR_REQUESTS_CPU: "100m"
  MONITOR_LIMITS_MEMORY: "1024Mi"
  MONITOR_LIMITS_CPU: "500m"
  
  # Resource configuration - PgBouncer
  PGBOUNCER_REQUESTS_MEMORY: "64Mi"
  PGBOUNCER_REQUESTS_CPU: "50m"
  PGBOUNCER_LIMITS_MEMORY: "256Mi"
  PGBOUNCER_LIMITS_CPU: "500m"
  
  # PostgreSQL tuning
  MAX_CONNECTIONS: "250"
  SHARED_BUFFERS: "128MB"
  EFFECTIVE_CACHE_SIZE: "512MB"
  WAL_BUFFERS: "16MB"
  MAX_WAL_SENDERS: "10"
  MAX_REPLICATION_SLOTS: "10"
  WAL_KEEP_SEGMENTS: "64"  # 64 Ã— 16MB = 1GB (use wal_keep_size for PG13+)
  
  # PgBouncer tuning
  POOL_MODE: "transaction"
  DEFAULT_POOL_SIZE: "10"
  MAX_CLIENT_CONN: "100"
  RESERVE_POOL_SIZE: "2"
  MAX_DB_CONNECTIONS: "50"
  
  # Probe timings
  READINESS_INITIAL_DELAY: "30"
  READINESS_PERIOD: "15"
  LIVENESS_INITIAL_DELAY: "30"
  LIVENESS_PERIOD: "45"
  
  # DNS settings
  MONITOR_HOST: "postgres-monitor.db.svc.cluster.local"
  PRIMARY_HOST: "postgres-primary.db.svc.cluster.local"
  REPLICAS_HOST: "postgres-replicas.db.svc.cluster.local"
  NODES_SERVICE: "postgres-nodes.db.svc.cluster.local"

